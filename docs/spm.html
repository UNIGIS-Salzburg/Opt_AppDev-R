<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Lesson 9 Spatial Data Manipulation | Automated Data Processing with R</title>
  <meta name="description" content="BookDown materials for the UNIGIS module Application Development - Introduction to R." />
  <meta name="generator" content="bookdown 0.40 and GitBook 2.6.7" />

  <meta property="og:title" content="Lesson 9 Spatial Data Manipulation | Automated Data Processing with R" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/branding/Cover_epub.png" />
  <meta property="og:description" content="BookDown materials for the UNIGIS module Application Development - Introduction to R." />
  <meta name="github-repo" content="UNIGIS-Salzburg/En_AppDev-R" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Lesson 9 Spatial Data Manipulation | Automated Data Processing with R" />
  
  <meta name="twitter:description" content="BookDown materials for the UNIGIS module Application Development - Introduction to R." />
  <meta name="twitter:image" content="/branding/Cover_epub.png" />

<meta name="author" content="Christian Neuwirth &amp; Maximilian Elixhauser" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="branding/unigis_globe_gruen_transparent.png" type="image/x-icon" />
<link rel="prev" href="readwrite.html"/>
<link rel="next" href="data-viz.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.2.2/leaflet.js"></script>
<script src="libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="css/custom.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="https://unigis.at/en" target="_blank"><img alt="UNIGIS Salzburg" src="branding/UNIGIS_Salzburg_Schriftlogo_v05.png" width=100%></a></li>
<li><a href="./">Automated Data Processing with R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction to R</a>
<ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#about-this-module"><i class="fa fa-check"></i><b>1.1</b> About this module</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#r-programming-language"><i class="fa fa-check"></i><b>1.2</b> R programming language</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#installation-and-setup"><i class="fa fa-check"></i><b>1.3</b> Installation and Setup</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#interpreting-values"><i class="fa fa-check"></i><b>1.4</b> Interpreting Values</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#simple-data-types"><i class="fa fa-check"></i><b>1.5</b> Simple Data Types</a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#numop"><i class="fa fa-check"></i><b>1.6</b> Numeric operators</a></li>
<li class="chapter" data-level="1.7" data-path="intro.html"><a href="intro.html#logical-operators"><i class="fa fa-check"></i><b>1.7</b> Logical operators</a></li>
<li class="chapter" data-level="1.8" data-path="intro.html"><a href="intro.html#references"><i class="fa fa-check"></i><b>1.8</b> References</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="core.html"><a href="core.html"><i class="fa fa-check"></i><b>2</b> Core Concepts</a>
<ul>
<li class="chapter" data-level="2.1" data-path="core.html"><a href="core.html#variables"><i class="fa fa-check"></i><b>2.1</b> Variables</a></li>
<li class="chapter" data-level="2.2" data-path="core.html"><a href="core.html#algorithms-and-functions"><i class="fa fa-check"></i><b>2.2</b> Algorithms and Functions</a></li>
<li class="chapter" data-level="2.3" data-path="core.html"><a href="core.html#libraries"><i class="fa fa-check"></i><b>2.3</b> Libraries</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="DS.html"><a href="DS.html"><i class="fa fa-check"></i><b>3</b> Data Structures</a>
<ul>
<li class="chapter" data-level="3.1" data-path="DS.html"><a href="DS.html#vectors"><i class="fa fa-check"></i><b>3.1</b> Vectors</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="DS.html"><a href="DS.html#vector-element-selection"><i class="fa fa-check"></i><b>3.1.1</b> Vector Element Selection</a></li>
<li class="chapter" data-level="3.1.2" data-path="DS.html"><a href="DS.html#using-the-range-function-with-vectors"><i class="fa fa-check"></i><b>3.1.2</b> Using the range() Function with Vectors</a></li>
<li class="chapter" data-level="3.1.3" data-path="DS.html"><a href="DS.html#applying-functions-to-vectors"><i class="fa fa-check"></i><b>3.1.3</b> Applying Functions to Vectors</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="DS.html"><a href="DS.html#multi-dimensional-data-types"><i class="fa fa-check"></i><b>3.2</b> Multi-dimensional Data Types</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="DS.html"><a href="DS.html#matrices"><i class="fa fa-check"></i><b>3.2.1</b> Matrices</a></li>
<li class="chapter" data-level="3.2.2" data-path="DS.html"><a href="DS.html#arrays"><i class="fa fa-check"></i><b>3.2.2</b> Arrays</a></li>
<li class="chapter" data-level="3.2.3" data-path="DS.html"><a href="DS.html#selection-in-multi-dimensional-data-types"><i class="fa fa-check"></i><b>3.2.3</b> Selection in Multi-Dimensional Data Types</a></li>
<li class="chapter" data-level="3.2.4" data-path="DS.html"><a href="DS.html#lists"><i class="fa fa-check"></i><b>3.2.4</b> Lists</a></li>
<li class="chapter" data-level="3.2.5" data-path="DS.html"><a href="DS.html#data-frame"><i class="fa fa-check"></i><b>3.2.5</b> Data Frame</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="spds.html"><a href="spds.html"><i class="fa fa-check"></i><b>4</b> Spatial Data Structures</a>
<ul>
<li class="chapter" data-level="4.1" data-path="spds.html"><a href="spds.html#vector-data-structures"><i class="fa fa-check"></i><b>4.1</b> Vector Data Structures</a></li>
<li class="chapter" data-level="4.2" data-path="spds.html"><a href="spds.html#raster-data-structures"><i class="fa fa-check"></i><b>4.2</b> Raster Data Structures</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="spds.html"><a href="spds.html#working-with-spatraster-objects"><i class="fa fa-check"></i><b>4.2.1</b> Working with SpatRaster objects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="control-structures.html"><a href="control-structures.html"><i class="fa fa-check"></i><b>5</b> Control Structures</a>
<ul>
<li class="chapter" data-level="5.1" data-path="control-structures.html"><a href="control-structures.html#if"><i class="fa fa-check"></i><b>5.1</b> If</a></li>
<li class="chapter" data-level="5.2" data-path="control-structures.html"><a href="control-structures.html#else"><i class="fa fa-check"></i><b>5.2</b> Else</a></li>
<li class="chapter" data-level="5.3" data-path="control-structures.html"><a href="control-structures.html#code-blocks"><i class="fa fa-check"></i><b>5.3</b> Code blocks</a></li>
<li class="chapter" data-level="5.4" data-path="control-structures.html"><a href="control-structures.html#loops"><i class="fa fa-check"></i><b>5.4</b> Loops</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="control-structures.html"><a href="control-structures.html#while-and-repeat"><i class="fa fa-check"></i><b>5.4.1</b> While and repeat</a></li>
<li class="chapter" data-level="5.4.2" data-path="control-structures.html"><a href="control-structures.html#for"><i class="fa fa-check"></i><b>5.4.2</b> For</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="control-structures.html"><a href="control-structures.html#loops-with-conditional-statements"><i class="fa fa-check"></i><b>5.5</b> Loops with conditional statements</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="control-structures.html"><a href="control-structures.html#exercise-loops-with-conditional-statements"><i class="fa fa-check"></i><b>5.5.1</b> Exercise: loops with conditional statements</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="functions.html"><a href="functions.html"><i class="fa fa-check"></i><b>6</b> Functions</a>
<ul>
<li class="chapter" data-level="6.1" data-path="functions.html"><a href="functions.html#defining-functions"><i class="fa fa-check"></i><b>6.1</b> Defining Functions</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="functions.html"><a href="functions.html#understanding-the-return-function"><i class="fa fa-check"></i><b>6.1.1</b> Understanding the <code>return()</code> Function</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="functions.html"><a href="functions.html#more-parameters"><i class="fa fa-check"></i><b>6.2</b> More Parameters</a></li>
<li class="chapter" data-level="6.3" data-path="functions.html"><a href="functions.html#returning-multiple-values"><i class="fa fa-check"></i><b>6.3</b> Returning Multiple Values</a></li>
<li class="chapter" data-level="6.4" data-path="functions.html"><a href="functions.html#functions-and-control-structures"><i class="fa fa-check"></i><b>6.4</b> Functions and Control Structures</a></li>
<li class="chapter" data-level="6.5" data-path="functions.html"><a href="functions.html#scope"><i class="fa fa-check"></i><b>6.5</b> Scope</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="datman.html"><a href="datman.html"><i class="fa fa-check"></i><b>7</b> Data Manipulation</a>
<ul>
<li class="chapter" data-level="7.1" data-path="datman.html"><a href="datman.html#preparation"><i class="fa fa-check"></i><b>7.1</b> Preparation</a></li>
<li class="chapter" data-level="7.2" data-path="datman.html"><a href="datman.html#data-manipulation"><i class="fa fa-check"></i><b>7.2</b> Data manipulation</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="datman.html"><a href="datman.html#summarise"><i class="fa fa-check"></i><b>7.2.1</b> Summarise</a></li>
<li class="chapter" data-level="7.2.2" data-path="datman.html"><a href="datman.html#select-and-filter"><i class="fa fa-check"></i><b>7.2.2</b> Select and filter</a></li>
<li class="chapter" data-level="7.2.3" data-path="datman.html"><a href="datman.html#mutate"><i class="fa fa-check"></i><b>7.2.3</b> Mutate</a></li>
<li class="chapter" data-level="7.2.4" data-path="datman.html"><a href="datman.html#arrange"><i class="fa fa-check"></i><b>7.2.4</b> Arrange</a></li>
<li class="chapter" data-level="7.2.5" data-path="datman.html"><a href="datman.html#exercise-data-manipulation"><i class="fa fa-check"></i><b>7.2.5</b> Exercise: data manipulation</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="datman.html"><a href="datman.html#join"><i class="fa fa-check"></i><b>7.3</b> Join</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="datman.html"><a href="datman.html#exercise-join"><i class="fa fa-check"></i><b>7.3.1</b> Exercise: join</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="readwrite.html"><a href="readwrite.html"><i class="fa fa-check"></i><b>8</b> Read and Write Data</a>
<ul>
<li class="chapter" data-level="8.1" data-path="readwrite.html"><a href="readwrite.html#read-and-write-tabular-data"><i class="fa fa-check"></i><b>8.1</b> Read and write tabular data</a></li>
<li class="chapter" data-level="8.2" data-path="readwrite.html"><a href="readwrite.html#read-and-write-vector-data"><i class="fa fa-check"></i><b>8.2</b> Read and write vector data</a></li>
<li class="chapter" data-level="8.3" data-path="readwrite.html"><a href="readwrite.html#read-and-write-raster-data"><i class="fa fa-check"></i><b>8.3</b> Read and write raster data</a></li>
<li class="chapter" data-level="8.4" data-path="readwrite.html"><a href="readwrite.html#data-api"><i class="fa fa-check"></i><b>8.4</b> Data API</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="spm.html"><a href="spm.html"><i class="fa fa-check"></i><b>9</b> Spatial Data Manipulation</a>
<ul>
<li class="chapter" data-level="9.1" data-path="spm.html"><a href="spm.html#data-acquisition"><i class="fa fa-check"></i><b>9.1</b> Data Acquisition</a></li>
<li class="chapter" data-level="9.2" data-path="spm.html"><a href="spm.html#data-cleaning"><i class="fa fa-check"></i><b>9.2</b> Data Cleaning</a></li>
<li class="chapter" data-level="9.3" data-path="spm.html"><a href="spm.html#vector-operations"><i class="fa fa-check"></i><b>9.3</b> Vector operations</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="spm.html"><a href="spm.html#geometrical-operations"><i class="fa fa-check"></i><b>9.3.1</b> Geometrical operations</a></li>
<li class="chapter" data-level="9.3.2" data-path="spm.html"><a href="spm.html#binary-operations"><i class="fa fa-check"></i><b>9.3.2</b> Binary operations</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="spm.html"><a href="spm.html#raster-operations"><i class="fa fa-check"></i><b>9.4</b> Raster operations</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="spm.html"><a href="spm.html#resampling"><i class="fa fa-check"></i><b>9.4.1</b> Resampling</a></li>
<li class="chapter" data-level="9.4.2" data-path="spm.html"><a href="spm.html#crop-raster"><i class="fa fa-check"></i><b>9.4.2</b> Crop raster</a></li>
<li class="chapter" data-level="9.4.3" data-path="spm.html"><a href="spm.html#raster-algebra"><i class="fa fa-check"></i><b>9.4.3</b> Raster algebra</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="data-viz.html"><a href="data-viz.html"><i class="fa fa-check"></i><b>10</b> Data Visualization</a>
<ul>
<li class="chapter" data-level="10.1" data-path="data-viz.html"><a href="data-viz.html#the-grammar-of-graphics"><i class="fa fa-check"></i><b>10.1</b> The Grammar of Graphics</a></li>
<li class="chapter" data-level="10.2" data-path="data-viz.html"><a href="data-viz.html#understanding-wide-and-long-data-formats-in-r"><i class="fa fa-check"></i><b>10.2</b> Understanding Wide and Long Data Formats in R</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="data-viz.html"><a href="data-viz.html#wide-format"><i class="fa fa-check"></i><b>10.2.1</b> Wide format</a></li>
<li class="chapter" data-level="10.2.2" data-path="data-viz.html"><a href="data-viz.html#long-format"><i class="fa fa-check"></i><b>10.2.2</b> Long format:</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="data-viz.html"><a href="data-viz.html#visualization-of-distributions"><i class="fa fa-check"></i><b>10.3</b> Visualization of distributions</a></li>
<li class="chapter" data-level="10.4" data-path="data-viz.html"><a href="data-viz.html#boxplots"><i class="fa fa-check"></i><b>10.4</b> Boxplots</a></li>
<li class="chapter" data-level="10.5" data-path="data-viz.html"><a href="data-viz.html#scatterplots"><i class="fa fa-check"></i><b>10.5</b> Scatterplots</a></li>
<li class="chapter" data-level="10.6" data-path="data-viz.html"><a href="data-viz.html#map-visualization"><i class="fa fa-check"></i><b>10.6</b> Map Visualization</a></li>
<li class="chapter" data-level="10.7" data-path="data-viz.html"><a href="data-viz.html#interactive-maps"><i class="fa fa-check"></i><b>10.7</b> Interactive Maps</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="r-markdown.html"><a href="r-markdown.html"><i class="fa fa-check"></i><b>11</b> R Markdown</a>
<ul>
<li class="chapter" data-level="11.1" data-path="r-markdown.html"><a href="r-markdown.html#set-up-your-work-environment"><i class="fa fa-check"></i><b>11.1</b> Set up your work environment</a></li>
<li class="chapter" data-level="11.2" data-path="r-markdown.html"><a href="r-markdown.html#create-a-local-clone"><i class="fa fa-check"></i><b>11.2</b> Create a local clone</a></li>
<li class="chapter" data-level="11.3" data-path="r-markdown.html"><a href="r-markdown.html#creating-your-first-r-markdown-document"><i class="fa fa-check"></i><b>11.3</b> Creating Your First R Markdown Document</a></li>
<li class="chapter" data-level="11.4" data-path="r-markdown.html"><a href="r-markdown.html#synchronizing-with-github"><i class="fa fa-check"></i><b>11.4</b> Synchronizing with GitHub</a></li>
<li class="chapter" data-level="11.5" data-path="r-markdown.html"><a href="r-markdown.html#basic-r-markdown-syntax"><i class="fa fa-check"></i><b>11.5</b> Basic R Markdown Syntax</a>
<ul>
<li class="chapter" data-level="11.5.1" data-path="r-markdown.html"><a href="r-markdown.html#references-in-rmarkdown"><i class="fa fa-check"></i><b>11.5.1</b> References in RMarkdown</a></li>
</ul></li>
<li class="chapter" data-level="11.6" data-path="r-markdown.html"><a href="r-markdown.html#speed-up-your-workflows"><i class="fa fa-check"></i><b>11.6</b> Speed up your workflows</a></li>
<li class="chapter" data-level="11.7" data-path="r-markdown.html"><a href="r-markdown.html#self-study"><i class="fa fa-check"></i><b>11.7</b> Self-study</a></li>
</ul></li>
<li class="divider"></li>
<li>Copyright © UNIGIS Salzburg.</li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Automated Data Processing with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="spm" class="section level1 hasAnchor" number="9">
<h1><span class="header-section-number">Lesson 9</span> Spatial Data Manipulation<a href="spm.html#spm" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In the previous lesson, you learned how to access data on a server via a REST API. The Open Geospatial Consortium (OGC) has adapted the REST API paradigm for geospatial applications. A variety of OGC API standards have been implemented to provide and utilize geospatial data on the web. An overview of the current implementation status can be found <a href="https://ogcapi.ogc.org/#standards" target="_blank">here</a>.</p>

<div class="rmdtip">
<p>In this lesson, we will utilize online data resources in workflows that involve data cleaning, spatial queries, and analyses. Additionally, you will learn to carry out basic raster manipulation operations on a sample raster dataset.</p>
</div>
<div id="data-acquisition" class="section level2 hasAnchor" number="9.1">
<h2><span class="header-section-number">9.1</span> Data Acquisition<a href="spm.html#data-acquisition" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We will work with vector data to correctly identify agricultural land parcels in European Union countries. The Austrian Agricultural Agency (<a href="https://www.ama.at/intro" target="_blank">AMA</a>) provides access to Austrian agricultural parcels through an <a href="https://ogcapi.ogc.org/" target="_blank">OGC Rest API - Feature</a> interface. The OGC API Features standard is the successor to the OGC Web Feature Service (WFS) specification.</p>

<div class="rmdtip">
<p>The R syntax used to interact with OGC APIs is the same as described in the “Data API” section (see Lesson <a href="readwrite.html#readwrite" target="_blank">8</a>).</p>
</div>
<p>Before loading the data into an R script, examine the API’s contents. Visit the web service’s <a href="https://gis.lfrz.gv.at/ogcapi009501/ogc/features/" target="_blank">landing page</a> and proceed to the <a href="https://gis.lfrz.gv.at/ogcapi009501/ogc/features/collections?f=text%2Fhtml" target="_blank">collection page</a>. There you will find an overview of the available layers.</p>
<p>Enter the following URL into your browser:</p>
<pre><code>https://gis.lfrz.gv.at/ogcapi009501/ogc/features/collections/ogcapi009501:INVEKOS_feldstuecke_aktuell_polygon/items?f=json&amp;limit=10</code></pre>
<p>This request returns the first ten features of the <code>ogcapi009501:INVEKOS_feldstuecke_aktuell_polygon</code> layer (agricultural land parcels as polygons) in GeoJSON format.</p>
<blockquote>
<p>GeoJSON is a JSON-based standard for representing simple geographic features, along with their non-spatial attributes.</p>
</blockquote>
<p>Upon inspecting the GeoJSON, you will find the coordinate vertices of the polygon features and attributes such as <code>fs_flaeche_ha</code> (parcel area in hectares) and <code>fnar_bezeichnung</code> (land use).</p>
<p>Use the <code>bbox</code> parameter to filter resources within a specific area:</p>
<pre><code>https://gis.lfrz.gv.at/ogcapi009501/ogc/features/collections/ogcapi009501:INVEKOS_feldstuecke_aktuell_polygon/items?f=json&amp;bbox=14,48,14.02,48.02 </code></pre>
<p>For a visual representation of the bounding box, enter the coordinates <code>14,48,14.02,48.02</code> into <a href="https://linestrings.com/bbox/" target="_blank">linestrings.com</a> and click “Display box”.</p>
<p>To execute the request in R, use the following script:</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="spm.html#cb219-1" tabindex="-1"></a><span class="fu">library</span>(httr2)</span>
<span id="cb219-2"><a href="spm.html#cb219-2" tabindex="-1"></a><span class="fu">library</span>(geojsonsf)</span>
<span id="cb219-3"><a href="spm.html#cb219-3" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb219-4"><a href="spm.html#cb219-4" tabindex="-1"></a></span>
<span id="cb219-5"><a href="spm.html#cb219-5" tabindex="-1"></a>full_url <span class="ot">&lt;-</span> <span class="st">&quot;https://gis.lfrz.gv.at/ogcapi009501/ogc/features/collections/ogcapi009501:INVEKOS_feldstuecke_aktuell_polygon/items?f=json&amp;bbox=14,48,14.02,48.02&quot;</span></span>
<span id="cb219-6"><a href="spm.html#cb219-6" tabindex="-1"></a></span>
<span id="cb219-7"><a href="spm.html#cb219-7" tabindex="-1"></a><span class="co"># Make the request and convert the response to an sf object</span></span>
<span id="cb219-8"><a href="spm.html#cb219-8" tabindex="-1"></a>invekos <span class="ot">&lt;-</span> httr2<span class="sc">::</span><span class="fu">request</span>(full_url) <span class="sc">%&gt;%</span>   <span class="co"># Create request</span></span>
<span id="cb219-9"><a href="spm.html#cb219-9" tabindex="-1"></a>  httr2<span class="sc">::</span><span class="fu">req_perform</span>() <span class="sc">%&gt;%</span>                <span class="co"># Execute request</span></span>
<span id="cb219-10"><a href="spm.html#cb219-10" tabindex="-1"></a>  httr2<span class="sc">::</span><span class="fu">resp_body_string</span>() <span class="sc">%&gt;%</span>           <span class="co"># Extract JSON body as string</span></span>
<span id="cb219-11"><a href="spm.html#cb219-11" tabindex="-1"></a>  geojsonsf<span class="sc">::</span><span class="fu">geojson_sf</span>()                 <span class="co"># Convert JSON string to sf object</span></span></code></pre></div>
<p>The above code retrieves 100 polygon features and stores them in an object named <code>invekos</code>.</p>
</div>
<div id="data-cleaning" class="section level2 hasAnchor" number="9.2">
<h2><span class="header-section-number">9.2</span> Data Cleaning<a href="spm.html#data-cleaning" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Once the data is loaded into R, we can more closely examine its structure. The <code>dplyr</code> function <code>glimpse</code>, for instance, allows us to preview each column’s name and type:</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="spm.html#cb220-1" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb220-2"><a href="spm.html#cb220-2" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">glimpse</span>(invekos)</span></code></pre></div>
<pre><code>## Rows: 100
## Columns: 15
## $ fart_id           &lt;dbl&gt; 1783, 1783, 1783, 1783, 1783, 1783, 1783, 1783, 1783…
## $ gml_geom          &lt;chr&gt; &quot;[B@38da99b7&quot;, &quot;[B@37b69cf4&quot;, &quot;[B@1ae80b5b&quot;, &quot;[B@51b…
## $ gml_length        &lt;dbl&gt; 786, 581, 550, 780, 754, 1160, 1090, 382, 448, 1535,…
## $ geom_date_created &lt;chr&gt; &quot;2022-10-01T04:48:30+02:00&quot;, &quot;2022-10-01T05:16:44+02…
## $ log_pkey          &lt;dbl&gt; 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3…
## $ fnar_code         &lt;chr&gt; &quot;A&quot;, &quot;G&quot;, &quot;A&quot;, &quot;A&quot;, &quot;A&quot;, &quot;A&quot;, &quot;A&quot;, &quot;G&quot;, &quot;A&quot;, &quot;A&quot;, &quot;A…
## $ gml_identifier    &lt;chr&gt; &quot;https://data.inspire.gv.at/0095/5f147bb9-7fe5-41ba-…
## $ fs_kennung        &lt;dbl&gt; 103931764, 103931719, 103931731, 103931769, 10384647…
## $ geo_part_key      &lt;dbl&gt; 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, …
## $ gml_id            &lt;chr&gt; &quot;AT.0095.5f147bb9-7fe5-41ba-a91e-0a3595c8335e.elu.Ex…
## $ inspire_id        &lt;chr&gt; &quot;https://data.inspire.gv.at/0095/5f147bb9-7fe5-41ba-…
## $ fnar_bezeichnung  &lt;chr&gt; &quot;ACKERLAND&quot;, &quot;GRÜNLAND&quot;, &quot;ACKERLAND&quot;, &quot;ACKERLAND&quot;, &quot;…
## $ fs_flaeche_ha     &lt;dbl&gt; 2.54829187, 0.12070263, 0.52804037, 1.39019474, 1.26…
## $ geo_id            &lt;dbl&gt; 12267790, 12286832, 12286835, 12267794, 12315820, 12…
## $ geometry          &lt;POLYGON [°]&gt; POLYGON ((14.01765 48.01724..., POLYGON ((14…</code></pre>
<blockquote>
<p>The abbreviation <code>dbl</code> stands for <code>double</code>, a data type that stores numbers with decimal points.</p>
</blockquote>
<p>To create a subset of the <code>invekos</code> sf-object, use the following code:</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="spm.html#cb222-1" tabindex="-1"></a>invekos <span class="sc">%&gt;%</span></span>
<span id="cb222-2"><a href="spm.html#cb222-2" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb222-3"><a href="spm.html#cb222-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(fnar_bezeichnung, fs_flaeche_ha, geo_id, geometry) <span class="sc">%&gt;%</span></span>
<span id="cb222-4"><a href="spm.html#cb222-4" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(., <span class="at">format=</span><span class="st">&quot;html&quot;</span>)</span></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align:left;">
fnar_bezeichnung
</th>
<th style="text-align:right;">
fs_flaeche_ha
</th>
<th style="text-align:right;">
geo_id
</th>
<th style="text-align:left;">
geometry
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
ACKERLAND
</td>
<td style="text-align:right;">
2.5482919
</td>
<td style="text-align:right;">
12267790
</td>
<td style="text-align:left;">
POLYGON ((14.01765 48.01724…
</td>
</tr>
<tr>
<td style="text-align:left;">
GRÜNLAND
</td>
<td style="text-align:right;">
0.1207026
</td>
<td style="text-align:right;">
12286832
</td>
<td style="text-align:left;">
POLYGON ((14.01353 48.02075…
</td>
</tr>
</tbody>
</table>
<p>Field names and entries are in German. To rename them, use the base R function <code>colnames()</code>:</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="spm.html#cb223-1" tabindex="-1"></a><span class="co"># Subset of invekos object</span></span>
<span id="cb223-2"><a href="spm.html#cb223-2" tabindex="-1"></a>invekos.sub <span class="ot">&lt;-</span> invekos <span class="sc">%&gt;%</span></span>
<span id="cb223-3"><a href="spm.html#cb223-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(fnar_bezeichnung, fs_flaeche_ha, geo_id, geometry)</span>
<span id="cb223-4"><a href="spm.html#cb223-4" tabindex="-1"></a></span>
<span id="cb223-5"><a href="spm.html#cb223-5" tabindex="-1"></a><span class="co"># Renaming fields</span></span>
<span id="cb223-6"><a href="spm.html#cb223-6" tabindex="-1"></a><span class="fu">colnames</span>(invekos.sub)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">&quot;land_use&quot;</span></span>
<span id="cb223-7"><a href="spm.html#cb223-7" tabindex="-1"></a><span class="fu">colnames</span>(invekos.sub)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;area_ha&quot;</span></span></code></pre></div>
<p>Entries are renamed using <code>dplyr</code>’s <code>mutate</code> and <code>case_when</code> functions:</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="spm.html#cb224-1" tabindex="-1"></a><span class="fu">unique</span>(invekos.sub<span class="sc">$</span>land_use)  <span class="co"># Unique entries in &#39;land_use&#39;</span></span></code></pre></div>
<pre><code>## [1] &quot;ACKERLAND&quot; &quot;GRÜNLAND&quot;</code></pre>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="spm.html#cb226-1" tabindex="-1"></a><span class="co"># Renaming entries &#39;ACKERLAND&#39; and &#39;GRÜNLAND&#39;</span></span>
<span id="cb226-2"><a href="spm.html#cb226-2" tabindex="-1"></a>invekos.sub <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(invekos.sub, <span class="at">land_use =</span> </span>
<span id="cb226-3"><a href="spm.html#cb226-3" tabindex="-1"></a>                               <span class="fu">case_when</span>(land_use <span class="sc">==</span> <span class="st">&#39;ACKERLAND&#39;</span> <span class="sc">~</span> <span class="st">&#39;arable land&#39;</span>,</span>
<span id="cb226-4"><a href="spm.html#cb226-4" tabindex="-1"></a>                               land_use <span class="sc">==</span> <span class="st">&#39;GRÜNLAND&#39;</span> <span class="sc">~</span> <span class="st">&#39;grassland&#39;</span>, <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">&#39;Other&#39;</span>))</span>
<span id="cb226-5"><a href="spm.html#cb226-5" tabindex="-1"></a></span>
<span id="cb226-6"><a href="spm.html#cb226-6" tabindex="-1"></a><span class="co"># Display result</span></span>
<span id="cb226-7"><a href="spm.html#cb226-7" tabindex="-1"></a>invekos.sub <span class="sc">%&gt;%</span></span>
<span id="cb226-8"><a href="spm.html#cb226-8" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb226-9"><a href="spm.html#cb226-9" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(., <span class="at">format=</span><span class="st">&quot;html&quot;</span>)</span></code></pre></div>
<table>
<thead>
<tr>
<th style="text-align:left;">
land_use
</th>
<th style="text-align:right;">
area_ha
</th>
<th style="text-align:right;">
geo_id
</th>
<th style="text-align:left;">
geometry
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
arable land
</td>
<td style="text-align:right;">
2.5482919
</td>
<td style="text-align:right;">
12267790
</td>
<td style="text-align:left;">
POLYGON ((14.01765 48.01724…
</td>
</tr>
<tr>
<td style="text-align:left;">
grassland
</td>
<td style="text-align:right;">
0.1207026
</td>
<td style="text-align:right;">
12286832
</td>
<td style="text-align:left;">
POLYGON ((14.01353 48.02075…
</td>
</tr>
</tbody>
</table>
<p>For an initial visual impression, plot the sf-object using the base R <code>plot()</code> function:</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="spm.html#cb227-1" tabindex="-1"></a><span class="fu">plot</span>(invekos.sub[<span class="dv">1</span>], <span class="at">main=</span><span class="st">&quot;Land Use&quot;</span>, <span class="at">key.pos =</span> <span class="dv">1</span>, <span class="at">key.width =</span> <span class="fu">lcm</span>(<span class="fl">1.8</span>))</span></code></pre></div>
<p><img src="UNIGIS-AppDev-R_files/figure-html/unnamed-chunk-190-1.png" width="672" /></p>
<p>By default, the <code>plot()</code> function generates a multi-panel plot, with one sub-plot for each field of the object. However, specifying <code>invekos.sub[1]</code> restricts the output to a single plot, specifically showcasing the <code>land_use</code> field. The function parameter <code>key.pos = 1</code> aligns the legend below the map (1=below, 2=left, 3=above and 4=right). <code>key.width</code> defines the width of the legend.</p>
<p>Next, we can validate the geometry of sf polygons using <code>st_is_valid</code>:</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="spm.html#cb228-1" tabindex="-1"></a>sf<span class="sc">::</span><span class="fu">st_is_valid</span>(invekos) <span class="sc">%&gt;%</span></span>
<span id="cb228-2"><a href="spm.html#cb228-2" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code></pre></div>
<pre><code>##    Mode    TRUE 
## logical     100</code></pre>
<p>The <code>st_is_valid</code> function checks the validity of each geometry, returning a logical vector. The summary confirms that all geometries in our dataset are valid. If any invalid geometries are detected, they can be corrected using the <code>st_make_valid</code> function.</p>

<div class="rmdexercise">
<p>Let’s closely investigate a polygon geometry with the code below, which creates a single polygon feature. The validity check flags an invalid geometry. Can you identify the problem?</p>
</div>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="spm.html#cb230-1" tabindex="-1"></a><span class="co"># Coordinates for the polygon</span></span>
<span id="cb230-2"><a href="spm.html#cb230-2" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>), <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb230-3"><a href="spm.html#cb230-3" tabindex="-1"></a></span>
<span id="cb230-4"><a href="spm.html#cb230-4" tabindex="-1"></a><span class="co"># List of coordinate matrices</span></span>
<span id="cb230-5"><a href="spm.html#cb230-5" tabindex="-1"></a>list_of_coords <span class="ot">&lt;-</span> <span class="fu">list</span>(coords)</span>
<span id="cb230-6"><a href="spm.html#cb230-6" tabindex="-1"></a></span>
<span id="cb230-7"><a href="spm.html#cb230-7" tabindex="-1"></a><span class="co"># Constructing the polygon</span></span>
<span id="cb230-8"><a href="spm.html#cb230-8" tabindex="-1"></a>polygon <span class="ot">&lt;-</span> <span class="fu">st_polygon</span>(list_of_coords)</span>
<span id="cb230-9"><a href="spm.html#cb230-9" tabindex="-1"></a></span>
<span id="cb230-10"><a href="spm.html#cb230-10" tabindex="-1"></a><span class="co"># Converting to an sf object</span></span>
<span id="cb230-11"><a href="spm.html#cb230-11" tabindex="-1"></a>error_sf <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(<span class="at">geometry =</span> <span class="fu">st_sfc</span>(polygon))</span>
<span id="cb230-12"><a href="spm.html#cb230-12" tabindex="-1"></a></span>
<span id="cb230-13"><a href="spm.html#cb230-13" tabindex="-1"></a><span class="co"># Validity check</span></span>
<span id="cb230-14"><a href="spm.html#cb230-14" tabindex="-1"></a>sf<span class="sc">::</span><span class="fu">st_is_valid</span>(error_sf)</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<details closed>
<summary>
<ins>
<strong>See solution!</strong>
</ins>
</summary>
<p>
<p><font color="grey"></p>
<p>When plotted, the polygon reveals a <a href="https://en.wikipedia.org/wiki/Sliver_polygon" target="_blank">sliver polygon</a>, which is invalid due to its shape.</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="spm.html#cb232-1" tabindex="-1"></a><span class="fu">plot</span>(error_sf)</span></code></pre></div>
<p><img src="UNIGIS-AppDev-R_files/figure-html/unnamed-chunk-194-1.png" width="672" /></p>
<p>Another common cause of invalid geometries is self-intersection of lines.</p>
<blockquote>
<p>Note: A valid polygon requires at least four coordinate points with the first and last points being identical. A polygon with only three points is considered to have an invalid geometry.</p>
</blockquote>
</font>
</p>
</details>
</div>
<div id="vector-operations" class="section level2 hasAnchor" number="9.3">
<h2><span class="header-section-number">9.3</span> Vector operations<a href="spm.html#vector-operations" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The structure of an <code>sf</code> object is similar to that of data frames, enabling attribute-based filtering operations using <code>dplyr</code> functions, as described in Lesson <a href="datman.html#datman" target="_blank">7</a>.</p>
<p>For example, to extract grassland parcels, the <code>filter()</code> function is used:</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="spm.html#cb233-1" tabindex="-1"></a>invekos.sub <span class="sc">%&gt;%</span></span>
<span id="cb233-2"><a href="spm.html#cb233-2" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(land_use<span class="sc">==</span><span class="st">&#39;grassland&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb233-3"><a href="spm.html#cb233-3" tabindex="-1"></a>  {<span class="fu">plot</span>(.[<span class="dv">1</span>], <span class="at">main=</span><span class="st">&quot;Land Use&quot;</span>, <span class="at">key.pos =</span> <span class="dv">1</span>, <span class="at">key.width =</span> <span class="fu">lcm</span>(<span class="fl">1.8</span>))}</span></code></pre></div>
<p><img src="UNIGIS-AppDev-R_files/figure-html/unnamed-chunk-195-1.png" width="672" /></p>
<blockquote>
<p>Note the use of curly brackets in the <code>plot()</code> function. This is required because the dot notation (.) cannot directly index a piped value. For a deeper explanation, see this <a href="https://stackoverflow.com/questions/42385010/using-the-pipe-and-dot-notation" target="_blank">Stack Overflow discussion</a>.</p>
</blockquote>
<div id="geometrical-operations" class="section level3 hasAnchor" number="9.3.1">
<h3><span class="header-section-number">9.3.1</span> Geometrical operations<a href="spm.html#geometrical-operations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>sf</code> provides a range of geometric predicates such as <code>st_within</code>, <code>st_contains</code>, or <code>st_crosses</code>, with a complete list available <a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html" target="_blank">here</a>. While these are often used between pairs of simple feature geometry sets, they can also operate on a single <code>sf</code> object:</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="spm.html#cb234-1" tabindex="-1"></a>sf<span class="sc">::</span><span class="fu">st_intersects</span>(invekos.sub, <span class="at">sparse =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## Sparse geometry binary predicate list of length 100, where the
## predicate was `intersects&#39;
## first 10 elements:
##  1: 1, 17, 62
##  2: 2, 4, 16
##  3: 3, 64, 83
##  4: 2, 4
##  5: 5
##  6: 6, 36
##  7: 7, 8, 66, 99
##  8: 7, 8
##  9: 9, 28, 30, 54
##  10: 10, 74</code></pre>
<p>This returns a sparse matrix revealing intersections within features of the same <code>sf</code> object <code>invekos.sub</code>, indicating possible topology errors. For correcting these errors, GIS software like <a href="https://www.qgis.org/de/site/" target="_blank">QGIS</a> is recommended as R’s capabilities for handling topology errors are less advanced.</p>
</div>
<div id="binary-operations" class="section level3 hasAnchor" number="9.3.2">
<h3><span class="header-section-number">9.3.2</span> Binary operations<a href="spm.html#binary-operations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Binary operations are essential for analyzing spatial relationships between different datasets. Here, we demonstrate this by creating an <code>sf</code> object representing farmsteads using data from the <a href="https://gis.lfrz.gv.at/ogcapi009501/ogc/features/collections?f=text%2Fhtml" target="_blank">AMA Rest API service</a>:</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="spm.html#cb236-1" tabindex="-1"></a>full_url <span class="ot">&lt;-</span> <span class="st">&quot;https://gis.lfrz.gv.at/ogcapi009501/ogc/features/collections/ogcapi009501:INVEKOS_hofstellen_aktuell_point/items?f=json&amp;bbox=14,48,14.02,48.02&quot;</span></span>
<span id="cb236-2"><a href="spm.html#cb236-2" tabindex="-1"></a></span>
<span id="cb236-3"><a href="spm.html#cb236-3" tabindex="-1"></a>farms <span class="ot">&lt;-</span> httr2<span class="sc">::</span><span class="fu">request</span>(full_url) <span class="sc">%&gt;%</span>   <span class="co"># Create request</span></span>
<span id="cb236-4"><a href="spm.html#cb236-4" tabindex="-1"></a>  httr2<span class="sc">::</span><span class="fu">req_perform</span>() <span class="sc">%&gt;%</span>           <span class="co"># Execute request</span></span>
<span id="cb236-5"><a href="spm.html#cb236-5" tabindex="-1"></a>  httr2<span class="sc">::</span><span class="fu">resp_body_string</span>() <span class="sc">%&gt;%</span>      <span class="co"># Extract JSON body as string</span></span>
<span id="cb236-6"><a href="spm.html#cb236-6" tabindex="-1"></a>  geojsonsf<span class="sc">::</span><span class="fu">geojson_sf</span>()            <span class="co"># JSON string to sf object</span></span>
<span id="cb236-7"><a href="spm.html#cb236-7" tabindex="-1"></a></span>
<span id="cb236-8"><a href="spm.html#cb236-8" tabindex="-1"></a><span class="fu">plot</span>(invekos.sub[<span class="dv">1</span>], <span class="at">main=</span><span class="cn">NULL</span>, <span class="at">key.pos=</span><span class="cn">NULL</span>, <span class="at">reset =</span> <span class="cn">FALSE</span>, <span class="at">col_graticule =</span> <span class="st">&quot;grey&quot;</span>)</span>
<span id="cb236-9"><a href="spm.html#cb236-9" tabindex="-1"></a><span class="fu">plot</span>(farms[<span class="dv">1</span>], <span class="at">main=</span><span class="cn">NULL</span>, <span class="at">key.pos=</span><span class="cn">NULL</span>, <span class="at">pch =</span> <span class="dv">7</span>, <span class="at">col=</span><span class="st">&#39;red&#39;</span>, <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">cex=</span><span class="dv">1</span>)</span></code></pre></div>
<p><img src="UNIGIS-AppDev-R_files/figure-html/unnamed-chunk-197-1.png" width="672" /></p>
<blockquote>
<p>Note: The <code>plot()</code> function is used sequentially to overlay farm points on top of the land parcel polygons. For advanced plotting techniques, refer to the <a href="https://r-spatial.github.io/sf/reference/plot.html" target="_blank"><code>plot()</code> documentation</a>.</p>
</blockquote>
<p>We proceed to calculate the distances between farms and land parcels to determine proximity:</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="spm.html#cb237-1" tabindex="-1"></a>dist_m <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_distance</span>(farms, invekos.sub)</span></code></pre></div>
<p>The <code>st_distance</code> function calculates the shortest distance matrix between the geometries of the two <code>sf</code> objects, with distances returned in meters.</p>

<div class="rmdexercise">
<p>Distances are computed in meters, which may seem unexpected since the reference system’s units are in degrees. To understand the underlying calculations, examine the coordinate reference system of the <code>sf</code> objects <code>farms</code> and <code>invekos</code> using <code>sf::st_crs()</code>. This will reveal that objects use geographic coordinates (WGS 84).</p>
<p>In this short exercise, we will take a closer look at the algorithm that is implemented in function <code>st_distance</code>.</p>
<p>Open the <a href="https://r-spatial.github.io/sf/reference/geos_measures.html" target="_blank">documentation of <code>st_distance</code></a> to find out how metric distances were derived from geographic coordinates.</p>
<details closed>
<summary>
<ins>
<strong>See solution!</strong>
</ins>
</summary>
<p>
<p><font color="grey"></p>
<p>According to the documentation, greater circle distances are computed for geodetic coordinates. Greater circle distance calculations use by default spherical distances. Alternatively, distances can be computed based on an ellipsoidal model. See <a href="https://link.springer.com/article/10.1007/s00190-012-0578-z" target="_blank">Algorithms for geodesics, Journal of Geodesy</a> for more information.</p>
</font>
</p>
</details>
</div>
<p>When plotting the complete distance matrix <code>dist_m</code>, we see that column 1 contains the distances between the first feature (parcel 1) in sf-object <code>invekos</code> and the 10 farm features of sf-object <code>farms</code>. Accordingly, the matrix has 100 columns (one column for every parcel) and 10 rows (one row for every farm).</p>
<p>The following line returns the first column of the distance matrix as vector:</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="spm.html#cb238-1" tabindex="-1"></a>dist_m[, <span class="dv">1</span>]</span></code></pre></div>
<pre><code>## Units: [m]
##  [1]  255.9825  642.4693  547.6458  621.1653 1326.6061 1230.1068  510.2196
##  [8]  587.8220  926.4913  492.0585</code></pre>
<p>To identify the farm that is located closest to parcel 1, we need to query the index of the minimum value in this vector:</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="spm.html#cb240-1" tabindex="-1"></a><span class="fu">which</span>(dist_m[, <span class="dv">1</span>] <span class="sc">==</span> <span class="fu">min</span>(dist_m[, <span class="dv">1</span>]))</span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>The <code>which</code> function, a base R utility, identifies the indices of elements that satisfy a given condition. In the example, it returns the index of the smallest value within the vector <code>dist_m[, 1]</code>. Consequently, it indicates that farm 1 is the closest to parcel 1.</p>
<p>The demonstrated procedure for detecting closest farms can be executed for ever parcel in a for-loop. The number of the closest farm is appended to a vector named <code>closest</code>. This vector is in turn appended as a new column to sf-object <code>invekos.sub</code>. And <code>invekos.sub</code> is plotted together with <code>farms</code>:</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="spm.html#cb242-1" tabindex="-1"></a>closest <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb242-2"><a href="spm.html#cb242-2" tabindex="-1"></a></span>
<span id="cb242-3"><a href="spm.html#cb242-3" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>){</span>
<span id="cb242-4"><a href="spm.html#cb242-4" tabindex="-1"></a>  </span>
<span id="cb242-5"><a href="spm.html#cb242-5" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">which</span>(dist_m[, i] <span class="sc">==</span> <span class="fu">min</span>(dist_m[, i]))</span>
<span id="cb242-6"><a href="spm.html#cb242-6" tabindex="-1"></a>  </span>
<span id="cb242-7"><a href="spm.html#cb242-7" tabindex="-1"></a>  closest <span class="ot">&lt;-</span> <span class="fu">c</span>(closest, out)</span>
<span id="cb242-8"><a href="spm.html#cb242-8" tabindex="-1"></a>  </span>
<span id="cb242-9"><a href="spm.html#cb242-9" tabindex="-1"></a>}</span>
<span id="cb242-10"><a href="spm.html#cb242-10" tabindex="-1"></a></span>
<span id="cb242-11"><a href="spm.html#cb242-11" tabindex="-1"></a><span class="fu">cbind</span>(invekos.sub, closest) <span class="sc">%&gt;%</span></span>
<span id="cb242-12"><a href="spm.html#cb242-12" tabindex="-1"></a>  {<span class="fu">plot</span>(.[<span class="dv">4</span>], <span class="at">main=</span><span class="cn">NULL</span>, <span class="at">key.pos=</span><span class="cn">NULL</span>, <span class="at">reset =</span> <span class="cn">FALSE</span>)}</span>
<span id="cb242-13"><a href="spm.html#cb242-13" tabindex="-1"></a></span>
<span id="cb242-14"><a href="spm.html#cb242-14" tabindex="-1"></a><span class="fu">plot</span>(farms[<span class="dv">1</span>], <span class="at">main=</span><span class="cn">NULL</span>, <span class="at">key.pos=</span><span class="cn">NULL</span>, <span class="at">pch =</span> <span class="dv">7</span>, <span class="at">col=</span><span class="st">&#39;red&#39;</span>, <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">cex=</span><span class="dv">1</span>)</span></code></pre></div>
<p><img src="UNIGIS-AppDev-R_files/figure-html/unnamed-chunk-202-1.png" width="672" /></p>
<p>The output map visualizes the closest farm to each agricultural parcel, highlighting the practical application of <code>sf</code> Geometrical operations.</p>
<p>This chapter focuses on logical matrix outputs from geometric operations. For operations generating new geometries, such as <code>st_union</code>, <code>st_buffer</code>, and <code>st_centroid</code>, see <a href="https://r-spatial.github.io/sf/articles/sf3.html#operations-returning-a-geometry" target="_blank">operations returning a geometry</a>. For network operations on <code>sf</code> objects, consider using <code>sfnetworks</code> or the <code>igraph</code> package.</p>
</div>
</div>
<div id="raster-operations" class="section level2 hasAnchor" number="9.4">
<h2><span class="header-section-number">9.4</span> Raster operations<a href="spm.html#raster-operations" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Having previously discussed the structure of <code>SpatRaster Objects</code> in Lesson <a href="spds.html#spds" target="_blank">4</a> and the reading and writing of such objects in Lesson <a href="readwrite.html#readwrite" target="_blank">8</a>, we now turn our attention to raster manipulation operations like <em>resampling</em> and <em>cropping</em>.</p>
<blockquote>
<p>For the following examples, we will utilize a sample dataset from the <code>terra</code> package. You can download the sample data <a href="data/terra_sample.tif" target="_blank">here</a>).</p>
</blockquote>
<div id="resampling" class="section level3 hasAnchor" number="9.4.1">
<h3><span class="header-section-number">9.4.1</span> Resampling<a href="spm.html#resampling" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Resampling is crucial for working with raster datasets. It alters the spatial resolution, allowing you to align multiple rasters with different resolutions. Additionally, it adjusts the level of detail necessary for your analysis.</p>
<p>Let’s demonstrate resampling with the <code>terra</code> sample dataset:</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="spm.html#cb243-1" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb243-2"><a href="spm.html#cb243-2" tabindex="-1"></a></span>
<span id="cb243-3"><a href="spm.html#cb243-3" tabindex="-1"></a>r <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(<span class="st">&quot;data/terra_sample.tif&quot;</span>) <span class="co"># path may be different on your machine</span></span>
<span id="cb243-4"><a href="spm.html#cb243-4" tabindex="-1"></a><span class="fu">plot</span>(r, <span class="at">main=</span><span class="st">&#39;SpatRaster from file&#39;</span>)</span></code></pre></div>
<p><img src="UNIGIS-AppDev-R_files/figure-html/unnamed-chunk-203-1.png" width="672" /></p>
<p>Before we change the raster resolution of <code>SpatRaster Object</code>, it is important to know the original resolution of the raster. You can use the <code>res()</code> function to check the original resolution:</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="spm.html#cb244-1" tabindex="-1"></a><span class="fu">res</span>(r)</span></code></pre></div>
<pre><code>## [1] 40 40</code></pre>
<p>For resampling, we’ll create a target raster by copying the original and setting a new resolution:</p>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb246-1"><a href="spm.html#cb246-1" tabindex="-1"></a>r2 <span class="ot">&lt;-</span> r</span>
<span id="cb246-2"><a href="spm.html#cb246-2" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">res</span>(r2) <span class="ot">&lt;-</span> <span class="dv">80</span> <span class="co"># Assigning a new resolution of 80x80</span></span></code></pre></div>
<p>Although this operation clears the raster values, <code>r2</code> can still be used as a target for resampling:</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="spm.html#cb247-1" tabindex="-1"></a>r_resampled <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">resample</span>(r, r2, <span class="at">method=</span><span class="st">&quot;bilinear&quot;</span>)</span>
<span id="cb247-2"><a href="spm.html#cb247-2" tabindex="-1"></a></span>
<span id="cb247-3"><a href="spm.html#cb247-3" tabindex="-1"></a><span class="fu">res</span>(r2) <span class="co"># Verify the new resolution</span></span></code></pre></div>
<pre><code>## [1] 80 80</code></pre>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="spm.html#cb249-1" tabindex="-1"></a><span class="fu">plot</span>(r_resampled, <span class="at">main=</span><span class="st">&#39;Resampled 80x80&#39;</span>)</span></code></pre></div>
<p><img src="UNIGIS-AppDev-R_files/figure-html/unnamed-chunk-206-1.png" width="672" /></p>
<p>The <code>bilinear</code> method is used for interpolating new values in <code>r_resampled</code>, with alternatives such as <code>nearest</code> or <code>cubic</code>. The choice of interpolation method for resampling raster data is a crucial consideration, discussed in further detail <a href="https://gis.stackexchange.com/questions/2587/deciding-what-interpolation-method-to-use-for-resampling-raster-data" target="_blank">here</a>.</p>
</div>
<div id="crop-raster" class="section level3 hasAnchor" number="9.4.2">
<h3><span class="header-section-number">9.4.2</span> Crop raster<a href="spm.html#crop-raster" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Raster cropping allows you to select a specific area from a larger raster dataset for targeted analysis. Both <code>SpatRaster</code> and <code>SpatExtent</code> objects can be utilized for cropping operations.</p>
<p>To derive an extent from a <code>SpatRaster</code>, the <code>ext</code> function is used:</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="spm.html#cb250-1" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">ext</span>(r)</span></code></pre></div>
<pre><code>## SpatExtent : 178400, 181600, 329400, 334000 (xmin, xmax, ymin, ymax)</code></pre>
<p>The output format is <code>&lt;xmin, xmax, ymin, ymax&gt;</code>. Knowing this, we can define a cropping extent and apply it using the <code>crop</code> function:</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="spm.html#cb252-1" tabindex="-1"></a>crop_ext <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(<span class="dv">180000</span>, <span class="dv">180200</span>, <span class="dv">331000</span>, <span class="dv">331250</span>)</span>
<span id="cb252-2"><a href="spm.html#cb252-2" tabindex="-1"></a>subset_r <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(r, crop_ext)</span>
<span id="cb252-3"><a href="spm.html#cb252-3" tabindex="-1"></a><span class="fu">plot</span>(subset_r, <span class="at">main=</span><span class="st">&#39;Subset of r&#39;</span>)</span></code></pre></div>
<p><img src="UNIGIS-AppDev-R_files/figure-html/unnamed-chunk-208-1.png" width="672" /></p>
<p>If the resulting cropped area doesn’t match expectations due to cell alignment, adjust the cropping extent or raster resolution as necessary.</p>
</div>
<div id="raster-algebra" class="section level3 hasAnchor" number="9.4.3">
<h3><span class="header-section-number">9.4.3</span> Raster algebra<a href="spm.html#raster-algebra" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>Terra</code> provides functionality for algebraic operations on rasters, supporting standard arithmetic and logical operators, and functions like <code>abs</code> and <code>round</code>. For a full list, visit the <a href="https://rspatial.org/pkg/4-algebra.html" target="_blank">terra algebra documentation</a>.</p>
<p>Here’s how you can perform some simple operations:</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="spm.html#cb253-1" tabindex="-1"></a><span class="co"># Add a constant value to each cell</span></span>
<span id="cb253-2"><a href="spm.html#cb253-2" tabindex="-1"></a>s <span class="ot">&lt;-</span> r <span class="sc">+</span> <span class="dv">10</span></span>
<span id="cb253-3"><a href="spm.html#cb253-3" tabindex="-1"></a><span class="co"># Calculate the square root of cell values</span></span>
<span id="cb253-4"><a href="spm.html#cb253-4" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(r)</span>
<span id="cb253-5"><a href="spm.html#cb253-5" tabindex="-1"></a><span class="co"># Generate a logical raster based on cell value equality</span></span>
<span id="cb253-6"><a href="spm.html#cb253-6" tabindex="-1"></a>s1 <span class="ot">&lt;-</span> s <span class="sc">==</span> <span class="dv">15</span></span>
<span id="cb253-7"><a href="spm.html#cb253-7" tabindex="-1"></a></span>
<span id="cb253-8"><a href="spm.html#cb253-8" tabindex="-1"></a><span class="fu">plot</span>(s1)</span></code></pre></div>
<p><img src="UNIGIS-AppDev-R_files/figure-html/unnamed-chunk-209-1.png" width="672" /></p>
<p>Operators can be applied between <code>SpatRaster</code> objects with matching resolutions and origins. The result covers their spatial intersection.</p>
<p>You can also perform in-place replacements:</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="spm.html#cb254-1" tabindex="-1"></a>r[r <span class="sc">==</span> <span class="dv">255</span>] <span class="ot">&lt;-</span> <span class="dv">2550</span></span>
<span id="cb254-2"><a href="spm.html#cb254-2" tabindex="-1"></a><span class="fu">plot</span>(r)</span></code></pre></div>
<p><img src="UNIGIS-AppDev-R_files/figure-html/unnamed-chunk-210-1.png" width="672" /></p>
<p>Here, all cells with the value <code>255</code> are replaced with <code>2550</code>.</p>
<p>A broader range of vector and raster operations can be found in <a href="https://bookdown.org/robinlovelace/geocompr/geometric-operations.html" target="_blank">Chapter 5 - Geometry Operations, in the Book Geocomputation with R</a>.</p>

<div class="rmdtip">
<strong>Note:</strong> As of writing this module, “Geocomputation with R” uses the <code>raster</code> package, which is expected to be superseded by <code>terra</code>.
</div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="readwrite.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="data-viz.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
